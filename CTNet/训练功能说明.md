# 训练脚本功能增强说明

## 新增功能

### 1. 实时显示 Loss 和 Accuracy ✅

现在每个 epoch 结束后会实时显示：

```
────────────────────────────────────────────────────────────────────────────────
Epoch    1/1000 ★
  Train  | Loss: 0.823456 | Acc: 0.6523 (65.23%)
  Val    | Loss: 0.765432 | Acc: 0.7012 (70.12%)
  Best   | Epoch: 1 | Val Loss: 0.765432
  Early Stop | Patience: 0/50
────────────────────────────────────────────────────────────────────────────────
```

**显示内容包括：**
- **Train Loss/Acc**: 训练集的平均损失和准确率
- **Val Loss/Acc**: 验证集的损失和准确率
- **Best**: 最佳 epoch 和对应的验证损失
- **Early Stop**: 当前早停计数器状态
- **★标记**: 表示该 epoch 保存了最佳模型

### 2. 早停机制 (Early Stopping) ✅

#### 功能说明
当验证损失连续 N 个 epoch 没有改善时，自动停止训练，防止过拟合。

#### 参数配置

在文件末尾可以配置（第 551-554 行）：

```python
EARLY_STOPPING = True           # 是否启用早停
PATIENCE = 50                   # 早停耐心值（连续N个epoch不改善则停止）
MIN_DELTA = 0.0001              # 最小改善阈值（验证损失必须至少降低这么多才算改善）
VERBOSE = True                  # 是否显示详细信息
```

#### 工作原理

1. **监控验证损失**: 每个 epoch 结束后计算验证集损失
2. **判断是否改善**: 如果 `当前验证损失 < 最佳验证损失 - min_delta`，则认为是改善
3. **计数未改善次数**: 如果未改善，计数器 +1
4. **触发早停**: 当未改善次数 >= `patience` 时，停止训练

#### 早停触发示例

```
────────────────────────────────────────────────────────────────────────────────
⚠️  早停触发！连续 50 个 epoch 验证损失未改善
最佳 epoch: 234, 最佳验证损失: 0.542123
────────────────────────────────────────────────────────────────────────────────
```

## 配置参数说明

### 早停参数

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `EARLY_STOPPING` | bool | `True` | 是否启用早停机制 |
| `PATIENCE` | int | `50` | 连续多少个 epoch 未改善后停止 |
| `MIN_DELTA` | float | `0.0001` | 最小改善阈值 |
| `VERBOSE` | bool | `True` | 是否显示详细的训练信息 |

### 参数调优建议

#### Subject-Dependent 模式
```python
EARLY_STOPPING = True
PATIENCE = 30-50          # 可以设置较小的耐心值
MIN_DELTA = 0.0001        # 较小的改善阈值
```

#### LOSO 模式（跨受试者）
```python
EARLY_STOPPING = True
PATIENCE = 50-100         # 设置较大的耐心值（需要更多epoch收敛）
MIN_DELTA = 0.0005        # 可以设置稍大的改善阈值
```

#### 禁用早停
```python
EARLY_STOPPING = False    # 完全禁用早停，训练所有epoch
```

#### 禁用详细输出
```python
VERBOSE = False           # 只显示关键信息，减少输出
```

## 输出示例

### 训练开始
```
================================================================================
开始训练 Subject 1 - 启用早停机制 (patience=50)
================================================================================
```

### 每个 Epoch 输出
```
[CTNet][Epoch 1/1000] Step 1/10 loss=1.2345 acc=0.5623
[CTNet][Epoch 1/1000] Step 2/10 loss=1.1234 acc=0.6123
...

────────────────────────────────────────────────────────────────────────────────
Epoch    1/1000 ★
  Train  | Loss: 0.823456 | Acc: 0.6523 (65.23%)
  Val    | Loss: 0.765432 | Acc: 0.7012 (70.12%)
  Best   | Epoch: 1 | Val Loss: 0.765432
  Early Stop | Patience: 0/50
────────────────────────────────────────────────────────────────────────────────

[CTNet][Epoch 2/1000] Step 1/10 loss=0.9123 acc=0.6789
...
```

### 早停触发
```
────────────────────────────────────────────────────────────────────────────────
Epoch  284/1000
  Train  | Loss: 0.523456 | Acc: 0.8123 (81.23%)
  Val    | Loss: 0.652321 | Acc: 0.7512 (75.12%)
  Best   | Epoch: 234 | Val Loss: 0.542123
  Early Stop | Patience: 50/50
────────────────────────────────────────────────────────────────────────────────

================================================================================
⚠️  早停触发！连续 50 个 epoch 验证损失未改善
最佳 epoch: 234, 最佳验证损失: 0.542123
================================================================================
```

### 训练完成
```
================================================================================
训练完成！Subject 1
最佳 epoch: 234 / 284
测试准确率: 0.7823 (78.23%)
================================================================================
```

## 使用技巧

### 1. 根据训练情况调整耐心值

- 如果模型很快收敛：减小 `PATIENCE`（如 20-30）
- 如果模型需要更多时间：增大 `PATIENCE`（如 80-100）
- 如果不确定：保持默认值 50

### 2. 调整最小改善阈值

- 损失较大时（>1.0）：可以设置较大的 `MIN_DELTA`（如 0.001）
- 损失较小时（<0.5）：使用较小的 `MIN_DELTA`（如 0.0001）

### 3. 监控训练过程

关注以下指标：
- **Train Loss 持续下降**: 说明模型在学习
- **Val Loss 开始上升**: 可能出现过拟合
- **Val Acc 停止提升**: 可能需要调整学习率或模型结构

### 4. 禁用详细输出

如果输出太多影响查看：
```python
VERBOSE = False  # 只显示关键信息
LOG_INTERVAL = 5  # 减少batch级别的输出频率
```

## 兼容性

- ✅ 完全向后兼容：如果不设置新参数，使用默认值
- ✅ 不影响现有功能：所有原有功能保持不变
- ✅ 可以随时禁用：设置 `EARLY_STOPPING = False` 禁用早停

## 注意事项

1. **最佳模型保存**: 即使触发早停，也会加载最佳模型进行测试
2. **验证集划分**: 验证集是从每个batch的训练数据中划分的（比例为 `validate_ratio`）
3. **内存管理**: GPU内存会在每个epoch结束后自动清理
4. **结果保存**: 所有训练过程数据仍会保存到 Excel 文件中

