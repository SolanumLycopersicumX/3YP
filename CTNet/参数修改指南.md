# CTNet 训练参数修改指南

## 方法一：修改文件末尾的全局配置（推荐）

在 `CTNet_model.py` 文件的末尾（540-597行），直接修改以下参数：

### 1. 数据相关参数

```python
DATA_DIR = r'./mymat_raw/'          # 数据文件目录
EVALUATE_MODE = 'LOSO-No'          # 评估模式：'LOSO-No' 或 'LOSO'
N_SUBJECT = 9                       # 受试者数量 (1-9)
```

### 2. 训练相关参数

```python
EPOCHS = 1000                       # 训练轮数
N_AUG = 3                           # 数据增强倍数
N_SEG = 8                           # 数据增强分段数
validate_ratio = 0.3                # 验证集比例 (0.1-0.5)
```

### 3. Transformer 模型架构参数

```python
HEADS = 2                           # 多头注意力头数 (建议: 2, 4, 8)
EMB_DIM = 16                        # Transformer 嵌入维度 (建议: 16, 32, 48)
DEPTH = 6                           # Transformer 编码器层数 (建议: 3, 4, 6)
```

### 4. EEGNet (CNN) 参数

```python
EEGNet1_F1 = 8                      # 第一个卷积层滤波器数量
EEGNet1_KERNEL_SIZE = 64            # 时间卷积核大小
EEGNet1_D = 2                       # 深度卷积乘数
EEGNet1_POOL_SIZE1 = 8              # 第一个平均池化大小
EEGNet1_POOL_SIZE2 = 8              # 第二个平均池化大小
FLATTEN_EEGNet1 = 240               # 展平后的特征维度

# Dropout 率（根据评估模式自动调整）
if EVALUATE_MODE != 'LOSO':
    EEGNet1_DROPOUT_RATE = 0.5      # subject-dependent 模式
else:
    EEGNet1_DROPOUT_RATE = 0.25     # LOSO 模式
```

### 5. 数据集类型

```python
TYPE = 'B'                          # 'A' (BCI IV-2a, 4类, 22通道) 或 'B' (BCI IV-2b, 2类, 3通道)
parameters_list = ['A']             # 要训练的数据集列表
```

### 完整示例配置

```python
if __name__ == "__main__":
    # 数据配置
    DATA_DIR = r'./mymat_raw/'
    EVALUATE_MODE = 'LOSO-No'       # 改为 'LOSO' 进行跨受试者评估
    N_SUBJECT = 9
    
    # 训练配置
    EPOCHS = 2000                   # 增加训练轮数
    N_AUG = 5                       # 增加数据增强倍数
    N_SEG = 8
    validate_ratio = 0.2            # 减小验证集比例
    
    # Transformer 配置
    EMB_DIM = 32                    # 增加嵌入维度
    HEADS = 4                       # 增加注意力头数
    DEPTH = 6
    
    # EEGNet 配置
    TYPE = 'A'                      # 切换到数据集 A
    EEGNet1_F1 = 16                 # 增加滤波器数量
    EEGNet1_KERNEL_SIZE = 64
    EEGNet1_D = 2
    EEGNet1_POOL_SIZE1 = 8
    EEGNet1_POOL_SIZE2 = 8
    FLATTEN_EEGNet1 = 480           # 根据新的维度调整
    
    # Dropout 配置
    if EVALUATE_MODE != 'LOSO':
        EEGNet1_DROPOUT_RATE = 0.4
    else:
        EEGNet1_DROPOUT_RATE = 0.3
    
    parameters_list = ['A']         # 训练数据集 A
    # ... 其余代码保持不变
```

## 方法二：修改 main() 函数调用

如果需要传递不同的参数给 `main()` 函数，可以修改第 583 行的调用：

```python
result = main(RESULT_NAME,
                evaluate_mode = EVALUATE_MODE,
                heads=HEADS, 
                emb_size=EMB_DIM,
                depth=DEPTH, 
                dataset_type=TYPE,
                eeg1_f1 = EEGNet1_F1,
                eeg1_kernel_size = EEGNet1_KERNEL_SIZE,
                eeg1_D = EEGNet1_D,
                eeg1_pooling_size1 = EEGNet1_POOL_SIZE1,
                eeg1_pooling_size2 = EEGNet1_POOL_SIZE2,
                eeg1_dropout_rate = EEGNet1_DROPOUT_RATE,
                flatten_eeg1 = FLATTEN_EEGNet1,
                validate_ratio = validate_ratio,
              )
```

例如，可以直接覆盖某些参数：

```python
result = main(RESULT_NAME,
                evaluate_mode = 'LOSO',  # 覆盖默认值
                heads=4,                  # 覆盖默认值
                emb_size=32,              # 覆盖默认值
                # ... 其他参数可以保持默认或覆盖
              )
```

## 方法三：修改学习率和批次大小

当前代码中，`learning_rate` 和 `batch_size` 在 `ExP` 类中有默认值（第 237-238 行），但在 `main()` 函数中没有传递。要修改这些参数，需要：

### 步骤 1：修改 main() 函数定义

在第 449 行添加参数：

```python
def main(dirs,                
         evaluate_mode = 'subject-dependent',
         heads=8,
         emb_size=48,
         depth=3,
         dataset_type='A',
         eeg1_f1=20,
         eeg1_kernel_size=64,
         eeg1_D=2,
         eeg1_pooling_size1=8,
         eeg1_pooling_size2=8,
         eeg1_dropout_rate=0.3,
         flatten_eeg1=600,   
         validate_ratio = 0.2,
         learning_rate = 0.001,      # 新增
         batch_size = 72,            # 新增
         epochs = 2000,              # 新增（可选）
         number_aug = 2,             # 新增（可选）
         ):
```

### 步骤 2：在 ExP 调用时传递参数

在第 482 行修改：

```python
exp = ExP(i + 1, DATA_DIR, dirs, epochs, number_aug, N_SEG, None, 
          evaluate_mode = evaluate_mode,
          heads=heads, 
          emb_size=emb_size,
          depth=depth, 
          dataset_type=dataset_type,
          eeg1_f1 = eeg1_f1,
          eeg1_kernel_size = eeg1_kernel_size,
          eeg1_D = eeg1_D,
          eeg1_pooling_size1 = eeg1_pooling_size1,
          eeg1_pooling_size2 = eeg1_pooling_size2,
          eeg1_dropout_rate = eeg1_dropout_rate,
          flatten_eeg1 = flatten_eeg1,  
          validate_ratio = validate_ratio,
          learning_rate = learning_rate,  # 新增
          batch_size = batch_size,        # 新增
          )
```

### 步骤 3：在文件末尾调用时传递参数

在第 583 行添加：

```python
result = main(RESULT_NAME,
                evaluate_mode = EVALUATE_MODE,
                heads=HEADS, 
                emb_size=EMB_DIM,
                depth=DEPTH, 
                dataset_type=TYPE,
                eeg1_f1 = EEGNet1_F1,
                eeg1_kernel_size = EEGNet1_KERNEL_SIZE,
                eeg1_D = EEGNet1_D,
                eeg1_pooling_size1 = EEGNet1_POOL_SIZE1,
                eeg1_pooling_size2 = EEGNet1_POOL_SIZE2,
                eeg1_dropout_rate = EEGNet1_DROPOUT_RATE,
                flatten_eeg1 = FLATTEN_EEGNet1,
                validate_ratio = validate_ratio,
                learning_rate = 0.001,    # 新增：学习率
                batch_size = 64,          # 新增：批次大小
                epochs = EPOCHS,          # 新增：训练轮数
                number_aug = N_AUG,       # 新增：数据增强倍数
              )
```

## 方法四：快速修改常用参数

如果需要快速修改，可以在文件开头添加配置区域：

```python
# ========== 快速配置区域 ==========
# 训练参数
TRAINING_CONFIG = {
    'epochs': 1000,
    'batch_size': 72,
    'learning_rate': 0.001,
    'validate_ratio': 0.3,
    'n_aug': 3,
    'n_seg': 8,
}

# 模型参数
MODEL_CONFIG = {
    'heads': 2,
    'emb_size': 16,
    'depth': 6,
    'eeg1_f1': 8,
    'eeg1_kernel_size': 64,
    'eeg1_D': 2,
    'eeg1_pooling_size1': 8,
    'eeg1_pooling_size2': 8,
    'eeg1_dropout_rate': 0.5,
    'flatten_eeg1': 240,
}

# 数据参数
DATA_CONFIG = {
    'data_dir': r'./mymat_raw/',
    'evaluate_mode': 'LOSO-No',
    'dataset_type': 'A',
    'n_subject': 9,
}
# =================================
```

然后在文件末尾使用这些配置。

## 参数调优建议

### Subject-Dependent 模式（受试者内）
- **Dropout**: 0.25-0.3（较小）
- **学习率**: 0.001-0.0005
- **批次大小**: 64-128
- **训练轮数**: 1000-2000

### LOSO 模式（跨受试者）
- **Dropout**: 0.5（较大，防止过拟合）
- **学习率**: 0.0005-0.001
- **批次大小**: 32-64（较小）
- **训练轮数**: 1500-3000

### 数据集特定配置

#### 数据集 A (BCI IV-2a)
- `flatten_eeg1`: 通常为 600 或更大
- `eeg1_f1`: 16-20
- 22 个通道，4 个类别

#### 数据集 B (BCI IV-2b)
- `flatten_eeg1`: 通常为 240
- `eeg1_f1`: 8-16
- 3 个通道，2 个类别

## 注意事项

1. **flatten_eeg1 参数**：需要根据实际的 CNN 输出维度计算，修改其他 CNN 参数后可能需要调整
2. **内存限制**：批次大小过大可能导致 GPU 内存不足
3. **训练时间**：增加 `DEPTH`、`HEADS` 或 `EMB_DIM` 会显著增加训练时间
4. **数据增强**：`N_AUG` 增加会延长每个 epoch 的训练时间

